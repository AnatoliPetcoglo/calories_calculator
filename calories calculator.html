<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Запрет масштабирования и авто-зума в WebView -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
  <title>Calorie & Activity Planner</title>

  <!-- Gamified: coins, hearts, XP, daily quests & spin wheel -->
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    html, body { height: 100%; overflow-x: hidden; background:#f5f7fa; -webkit-text-size-adjust:100%; text-size-adjust:100%;}
    .tab-button{transition:.3s;cursor:pointer}
    .tab-button.border-indigo-600{border-bottom-width:2px}
    .result-card,.activity-card{transition:.3s ease;transform:translateY(20px);opacity:0}
    .result-card.show,.activity-card.show{transform:translateY(0);opacity:1}
    input, select, button { font-size: 16px; } /* без авто-зума на iOS */
    .badge{border:1px solid rgba(99,102,241,.3); padding:.2rem .5rem; border-radius:.5rem; font-size:.75rem}
    .progress-wrap{height:10px;background:#e5e7eb;border-radius:9999px;overflow:hidden}
    .progress-bar{height:100%;background:#6366f1;width:0%}
    .card{background:#fff; border-radius:1rem; box-shadow:0 20px 60px rgba(0,0,0,.15)}
    .onboarding{position:fixed; inset:0; background:linear-gradient(135deg,#eef2ff 0%,#ffffff 100%); z-index:50;}
    .hint{font-size:.75rem;color:#6b7280}

    /* --- Mobile Chrome modal scroll fixes --- */
    .modal-overlay { overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
    .modal-card-scroll { max-height: 90dvh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .body-locked { position: fixed; overflow: hidden; width: 100%; }
  </style>
</head>

<body class="min-h-screen font-sans">
<div class="max-w-screen-lg mx-auto px-4 py-6 md:py-8">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Calorie Calculator</h1>
      <p class="text-gray-600">Personal results, saved profile, and your activity plan</p>
    </div>
    <div class="flex items-center gap-2">
      <div class="flex items-center gap-3 mr-2 text-sm">
        <div class="flex items-center text-yellow-600"><i class="fa-solid fa-coins mr-1"></i><span id="coinsDisplay">0</span></div>
        <div class="flex items-center text-red-500"><i class="fa-solid fa-heart mr-1"></i><span id="heartsDisplay">0</span></div>
        <div class="flex items-center text-blue-600"><i class="fa-solid fa-star mr-1"></i><span id="levelDisplay">1</span></div>
      </div>
      <span id="goalBadge" class="badge hidden"></span>
      <button id="openProfile" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-white">
        <i class="fa-solid fa-user-gear mr-2"></i>Profile
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
    <button id="tabDashboard" class="tab-button py-3 px-5 font-medium text-indigo-600 border-indigo-600">Dashboard</button>
    <button id="tabActivity"  class="tab-button py-3 px-5 font-medium text-gray-500">Activity Plan</button>
    <button id="tabSchedule"  class="tab-button py-3 px-5 font-medium text-gray-500">Training Schedule</button>
    <button id="tabLog"       class="tab-button py-3 px-5 font-medium text-gray-500">Activity Log</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboardTab">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Your Results</h2>
        <div class="w-full md:w-2/5">
          <div class="text-xs text-gray-500 mb-1">Progress to goal</div>
          <div class="progress-wrap"><div id="goalProgressBar" class="progress-bar"></div></div>
          <div id="goalProgressText" class="text-xs text-gray-500 mt-1">0% completed</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="result-card bg-indigo-50 p-4 rounded-lg">
          <div class="flex items-center mb-2"><div class="p-2 bg-indigo-100 rounded-full mr-3"><i class="fas fa-fire text-indigo-600"></i></div><h3 class="font-medium">BMR</h3></div>
          <p id="bmr" class="text-3xl font-bold text-indigo-600">0</p><p class="text-xs text-gray-500">kcal/day</p>
        </div>
        <div class="result-card bg-blue-50 p-4 rounded-lg">
          <div class="flex items-center mb-2"><div class="p-2 bg-blue-100 rounded-full mr-3"><i class="fas fa-bolt text-blue-600"></i></div><h3 class="font-medium">TDEE</h3></div>
          <p id="tdee" class="text-3xl font-bold text-blue-600">0</p><p class="text-xs text-gray-500">kcal/day</p>
        </div>
        <div class="result-card bg-green-50 p-4 rounded-lg">
          <div class="flex items-center mb-2"><div class="p-2 bg-green-100 rounded-full mr-3"><i class="fas fa-bullseye text-green-600"></i></div><h3 class="font-medium">Target kcal</h3></div>
          <p id="goalCalories" class="text-3xl font-bold text-green-600">0</p><p id="goalText" class="text-xs text-gray-500">–</p>
        </div>
        <div class="result-card bg-purple-50 p-4 rounded-lg">
          <div class="flex items-center mb-2"><div class="p-2 bg-purple-100 rounded-full mr-3"><i class="fas fa-weight text-purple-600"></i></div><h3 class="font-medium">BMI</h3></div>
          <p id="bmiNow" class="text-xl font-bold text-purple-600">–</p><p id="bmiGoal" class="text-xs text-gray-500">Goal BMI: –</p>
        </div>
      </div>

      <!-- Daily target panel -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-amber-50 rounded-lg">
          <div class="text-sm text-gray-500">Daily target (kcal)</div>
          <div id="dailyTargetKcal" class="text-2xl font-bold text-amber-700">0</div>
          <div class="hint">Based on goal & remaining days</div>
        </div>
        <div class="p-4 bg-sky-50 rounded-lg">
          <div class="text-sm text-gray-500">Remaining kcal</div>
          <div id="remainingKcal" class="text-2xl font-bold text-sky-700">0</div>
        </div>
        <div class="p-4 bg-emerald-50 rounded-lg">
          <div class="text-sm text-gray-500">Days left</div>
          <div id="daysLeft" class="text-2xl font-bold text-emerald-700">0</div>
        </div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <a class="block bg-white rounded-xl shadow p-5 hover:shadow-md transition" onclick="switchTab('tabSchedule')">
        <div class="flex items-center mb-2"><i class="fa-solid fa-calendar-week mr-3 text-indigo-600"></i><div class="font-semibold">Auto-plan this week</div></div>
        <div class="text-sm text-gray-500">Week auto-fills after saving goal</div>
      </a>
      <a class="block bg-white rounded-xl shadow p-5 hover:shadow-md transition" onclick="switchTab('tabLog')">
        <div class="flex items-center mb-2"><i class="fa-solid fa-clipboard-check mr-3 text-green-600"></i><div class="font-semibold">Log today’s activity</div></div>
        <div class="text-sm text-gray-500">Add steps or minutes and track kcal</div>
      </a>
      <div class="bg-white rounded-xl shadow p-5">
        <div class="flex items-center mb-2"><i class="fa-solid fa-list-check mr-3 text-purple-600"></i><div class="font-semibold">Today’s plan</div></div>
        <div id="todayPlan" class="text-sm text-gray-600">—</div>
      </div>
    </div>

    <!-- Gamification widgets -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-white rounded-xl shadow p-5">
        <div class="flex items-center mb-2"><i class="fa-solid fa-arrows-rotate mr-3 text-pink-600"></i><div class="font-semibold">Daily Spin</div></div>
        <button id="spinBtn" class="px-3 py-2 bg-indigo-600 text-white rounded" onclick="spinWheel()">Spin</button>
        <div id="spinInfo" class="text-xs text-gray-500 mt-2"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-5">
        <div class="flex items-center mb-2"><i class="fa-solid fa-list-check mr-3 text-green-600"></i><div class="font-semibold">Daily Quests</div></div>
        <ul id="questsList" class="text-sm text-gray-600 space-y-2"></ul>
      </div>
    </div>
  </div>

  <!-- Activity Plan -->
  <div id="activityTab" class="hidden">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Your Activity Plan</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="activity-card bg-white border rounded-lg p-4 shadow-sm">
          <div class="flex items-center mb-3"><div class="p-2 bg-purple-100 rounded-full mr-3"><i class="fas fa-walking text-purple-600"></i></div><h4 class="font-medium">Walking</h4></div>
          <p class="text-sm text-gray-500">Steps/day</p><p id="steps" class="text-xl font-bold text-purple-600">0</p>
          <p class="text-xs text-gray-500">(~<span id="stepsCalories">0</span> kcal)</p>
          <p class="text-xs text-gray-500 mt-1">Total: <span id="stepsTotal">–</span></p>
        </div>
        <div class="activity-card bg-white border rounded-lg p-4 shadow-sm">
          <div class="flex items-center mb-3"><div class="p-2 bg-red-100 rounded-full mr-3"><i class="fas fa-running text-red-600"></i></div><h4 class="font-medium">Running</h4></div>
          <p class="text-sm text-gray-500">Min/day</p><p id="running" class="text-xl font-bold text-red-600">0 min</p>
          <p class="text-xs text-gray-500">(~<span id="runningCalories">0</span> kcal)</p>
          <p class="text-xs text-gray-500 mt-1">Total: <span id="runningTotal">–</span></p>
        </div>
        <div class="activity-card bg-white border rounded-lg p-4 shadow-sm">
          <div class="flex items-center mb-3"><div class="p-2 bg-yellow-100 rounded-full mr-3"><i class="fas fa-bicycle text-yellow-600"></i></div><h4 class="font-medium">Cycling</h4></div>
          <p class="text-sm text-gray-500">Min/day</p><p id="cycling" class="text-xl font-bold text-yellow-600">0 min</p>
          <p class="text-xs text-gray-500">(~<span id="cyclingCalories">0</span> kcal)</p>
          <p class="text-xs text-gray-500 mt-1">Total: <span id="cyclingTotal">–</span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Schedule -->
  <div id="scheduleTab" class="hidden">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Training Schedule (weekly)</h2>
        <div class="flex items-center gap-2">
          <button id="btnSaveSchedule" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Schedule</button>
        </div>
      </div>
      <div id="scheduleHint" class="hint mb-3"></div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="scheduleGrid"></div>
    </div>
  </div>

  <!-- Activity Log -->
  <div id="logTab" class="hidden">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Activity Log</h2>
        <button id="btnClearLog" class="px-3 py-2 border border-rose-300 text-rose-600 rounded-lg hover:bg-rose-50">Clear Log</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Date</label>
          <input id="logDate" type="date" class="w-full border rounded-lg px-3 py-2"/>
        </div>
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Type</label>
          <select id="logType" class="w-full border rounded-lg px-3 py-2">
            <option value="walk">Walking (steps)</option>
            <option value="run">Running (min)</option>
            <option value="cycle">Cycling (min)</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Amount</label>
          <input id="logAmount" type="number" min="1" placeholder="steps or minutes" class="w-full border rounded-lg px-3 py-2"/>
        </div>
        <div class="flex items-end">
          <button id="btnAddLog" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add to Log</button>
        </div>
      </div>

      <div class="overflow-auto">
        <table class="min-w-full border rounded-lg overflow-hidden">
          <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-3 py-2 border-b">Date</th>
            <th class="text-left px-3 py-2 border-b">Type</th>
            <th class="text-left px-3 py-2 border-b">Amount</th>
            <th class="text-left px-3 py-2 border-b">Kcal</th>
            <th class="text-left px-3 py-2 border-b">Actions</th>
          </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-indigo-50 rounded-lg">
          <div class="text-sm text-gray-500">Today burned</div>
          <div id="kcalToday" class="text-2xl font-bold text-indigo-600">0</div>
        </div>
        <div class="p-4 bg-green-50 rounded-lg">
          <div class="text-sm text-gray-500">This week burned</div>
          <div id="kcalWeek" class="text-2xl font-bold text-green-600">0</div>
        </div>
        <div class="p-4 bg-purple-50 rounded-lg">
          <div class="text-sm text-gray-500">Total burned (all time)</div>
          <div id="kcalTotal" class="text-2xl font-bold text-purple-600">0</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile modal -->
<div id="profileModal"
     class="fixed inset-0 bg-black/40 hidden z-50 flex modal-overlay
            items-start justify-center overflow-y-auto">
  <div class="card p-5 w-[92%] max-w-2xl my-[5dvh] modal-card-scroll">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-xl font-bold">Profile</h3>
      <button id="closeProfile" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <p class="text-sm text-gray-500 mb-4">Your goal and personal data are stored locally on this device.</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-gray-700 mb-1 font-medium">Units</label>
        <select id="pfUnits" class="w-full border rounded-lg px-3 py-2">
          <option value="metric">Metric (kg, cm)</option>
          <option value="imperial">Imperial (lb, ft+in)</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Goal</label>
        <select id="pfGoal" class="w-full border rounded-lg px-3 py-2">
          <option value="maintain">Maintain</option>
          <option value="lose">Weight Loss</option>
          <option value="gain">Weight Gain</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Gender</label>
        <select id="pfGender" class="w-full border rounded-lg px-3 py-2">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
      <div>
        <label class="block text-gray-700 mb-1 font-medium">Age</label>
        <input id="pfAge" type="number" min="10" max="100" class="w-full border rounded-lg px-3 py-2">
      </div>

      <!-- Weight -->
      <div id="pfWeightMetricWrap">
        <label class="block text-gray-700 mb-1 font-medium">Weight (kg)</label>
        <input id="pfWeightKg" type="number" min="30" max="300" step="0.1" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div id="pfWeightImperialWrap" class="hidden">
        <label class="block text-gray-700 mb-1 font-medium">Weight (lb)</label>
        <input id="pfWeightLb" type="number" min="66" max="660" step="0.1" class="w-full border rounded-lg px-3 py-2">
      </div>

      <!-- Height -->
      <div id="pfHeightMetricWrap">
        <label class="block text-gray-700 mb-1 font-medium">Height (cm)</label>
        <input id="pfHeightCm" type="number" min="120" max="250" step="0.1" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div id="pfHeightImperialWrap" class="hidden">
        <label class="block text-gray-700 mb-1 font-medium">Height (ft + in)</label>
        <div class="flex gap-2">
          <input id="pfHeightFt" type="number" min="3" max="8" class="w-full border rounded-lg px-3 py-2" placeholder="ft">
          <input id="pfHeightIn" type="number" min="0" max="11.99" step="0.1" class="w-full border rounded-lg px-3 py-2" placeholder="in">
        </div>
      </div>

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Activity</label>
        <select id="pfActivity" class="w-full border rounded-lg px-3 py-2">
          <option value="1.2">Sedentary</option>
          <option value="1.375">Lightly active</option>
          <option value="1.55">Moderately active</option>
          <option value="1.725">Very active</option>
          <option value="1.9">Extremely active</option>
        </select>
      </div>

      <!-- Target weight -->
      <div id="pfTargetMetricWrap">
        <label class="block text-gray-700 mb-1 font-medium">Desired Weight (kg)</label>
        <input id="pfTargetKg" type="number" min="30" max="300" step="0.1" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div id="pfTargetImperialWrap" class="hidden">
        <label class="block text-gray-700 mb-1 font-medium">Desired Weight (lb)</label>
        <input id="pfTargetLb" type="number" min="66" max="660" step="0.1" class="w-full border rounded-lg px-3 py-2">
      </div>

      <div id="pfDaysWrap">
        <label class="block text-gray-700 mb-1 font-medium">Timeframe (days)</label>
        <input id="pfDays" type="number" min="7" max="365" class="w-full border rounded-lg px-3 py-2">
      </div>
    </div>

    <div class="flex justify-between items-center mt-5">
      <button id="resetProfile" class="px-3 py-2 border rounded-lg">Reset</button>
      <div class="flex gap-2">
        <button id="saveProfileModal" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Onboarding -->
<div id="onboarding" class="onboarding hidden items-start overflow-y-auto modal-overlay">
  <div class="max-w-xl mx-auto p-5 w-[92%]">
    <div class="card p-6 modal-card-scroll my-[5dvh]">
      <h2 class="text-2xl font-bold mb-1">Welcome!</h2>
      <p class="text-gray-600 mb-4">Set your goal, units, personal data, desired weight and timeframe. You can edit later in Profile.</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div>
          <label class="block text-gray-700 mb-1 font-medium">Units</label>
          <select id="obUnits" class="w-full border rounded-lg px-3 py-2">
            <option value="metric" selected>Metric (kg, cm)</option>
            <option value="imperial">Imperial (lb, ft+in)</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-700 mb-1 font-medium">Goal</label>
          <select id="obGoal" class="w-full border rounded-lg px-3 py-2">
            <option value="maintain">Maintain</option>
            <option value="lose">Weight Loss</option>
            <option value="gain">Weight Gain</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-700 mb-1 font-medium">Gender</label>
          <select id="obGender" class="w-full border rounded-lg px-3 py-2">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-700 mb-1 font-medium">Age</label>
          <input id="obAge" type="number" min="10" max="100" value="30" class="w-full border rounded-lg px-3 py-2">
        </div>

        <!-- Activity (добавлено) -->
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Activity</label>
          <select id="obActivity" class="w-full border rounded-lg px-3 py-2">
            <option value="1.2">Sedentary</option>
            <option value="1.375">Lightly active</option>
            <option value="1.55" selected>Moderately active</option>
            <option value="1.725">Very active</option>
            <option value="1.9">Extremely active</option>
          </select>
        </div>

        <!-- Weight -->
        <div id="obWeightMetricWrap">
          <label class="block text-gray-700 mb-1 font-medium">Current Weight (kg)</label>
          <input id="obWeightKg" type="number" min="30" max="300" step="0.1" value="78" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div id="obWeightImperialWrap" class="hidden">
          <label class="block text-gray-700 mb-1 font-medium">Current Weight (lb)</label>
          <input id="obWeightLb" type="number" min="66" max="660" step="0.1" class="w-full border rounded-lg px-3 py-2">
        </div>

        <!-- Height -->
        <div id="obHeightMetricWrap">
          <label class="block text-gray-700 mb-1 font-medium">Height (cm)</label>
          <input id="obHeightCm" type="number" min="120" max="250" step="0.1" value="176" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div id="obHeightImperialWrap" class="hidden">
          <label class="block text-gray-700 mb-1 font-medium">Height (ft + in)</label>
          <div class="flex gap-2">
            <input id="obHeightFt" type="number" min="3" max="8" class="w-full border rounded-lg px-3 py-2" placeholder="ft">
            <input id="obHeightIn" type="number" min="0" max="11.99" step="0.1" class="w-full border rounded-lg px-3 py-2" placeholder="in">
          </div>
        </div>

        <!-- Target -->
        <div id="obTargetMetricWrap" class="md:col-span-2">
          <label class="block text-gray-700 mb-1 font-medium">Desired Weight (kg)</label>
          <input id="obTargetKg" type="number" min="30" max="300" step="0.1" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 72">
          <p class="hint mt-1">For Maintain, desired weight = current weight.</p>
        </div>
        <div id="obTargetImperialWrap" class="md:col-span-2 hidden">
          <label class="block text-gray-700 mb-1 font-medium">Desired Weight (lb)</label>
          <input id="obTargetLb" type="number" min="66" max="660" step="0.1" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 160">
          <p class="hint mt-1">For Maintain, desired weight = current weight.</p>
        </div>

        <div id="obDaysWrap" class="md:col-span-2">
          <label class="block text-gray-700 mb-1 font-medium">Timeframe (days)</label>
          <input id="obDays" type="number" min="7" max="365" value="100" class="w-full border rounded-lg px-3 py-2">
          <p class="hint mt-1">If empty for Lose/Gain, 30 days will be used.</p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-5">
        <button id="obSave" class="px-5 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save & Continue</button>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (s) => document.querySelector(s);
  const LS_PROFILE='cap.profile', LS_SCHEDULE='cap.schedule', LS_LOGS='cap.logs';
  const LS_GAME='cap.game', LS_QUESTS='cap.dailyQuests';
  const kcalPerKg = 7700;
  const WEEK=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  /* ===== Body scroll lock для модалок ===== */
  let __lockScrollY = 0;
  function lockBodyScroll(){ __lockScrollY = window.scrollY || window.pageYOffset || 0; document.body.classList.add('body-locked'); document.body.style.top = `-${__lockScrollY}px`; }
  function unlockBodyScroll(){ document.body.classList.remove('body-locked'); document.body.style.top = ''; window.scrollTo(0, __lockScrollY || 0); }

  /* ===== Локальные даты ===== */
  function localISO(d=new Date()){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function parseISO(s){ const [y,m,d]=s.split('-').map(n=>+n); return new Date(y, m-1, d); }
  function daysBetweenLocal(aISO, bISO){ const a=parseISO(aISO), b=parseISO(bISO); const ms=b-a; return Math.ceil(ms/86400000); }

  /* ===== Units helpers ===== */
  const KG_TO_LB = 2.2046226218;
  const CM_PER_IN = 2.54;
  function kgToLb(kg){ return kg * KG_TO_LB; }
  function lbToKg(lb){ return lb / KG_TO_LB; }
  function cmToFtIn(cm){ const totalIn = cm / CM_PER_IN; const ft = Math.floor(totalIn/12); const inch = totalIn - ft*12; return {ft, inch: Math.round(inch*10)/10}; }
  function ftInToCm(ft, inch){ return (ft*12 + (+inch||0)) * CM_PER_IN; }

  /* ===== Storage ===== */
  function readProfile(){ try{ return JSON.parse(localStorage.getItem(LS_PROFILE)||'{}'); }catch(e){ return {}; } }
  function writeProfile(p){ localStorage.setItem(LS_PROFILE, JSON.stringify(p)); }
  function hasProfile(){ const p=readProfile(); return !!(p && p.weight && p.height && p.age && p.activity && p.goal); }
  function getSchedule(){ try{ return JSON.parse(localStorage.getItem(LS_SCHEDULE)||'{}'); }catch(e){ return {}; } }
  function saveSchedule(s){ localStorage.setItem(LS_SCHEDULE, JSON.stringify(s||{})); }
  function getLogs(){ try{ return JSON.parse(localStorage.getItem(LS_LOGS)||'[]'); }catch(e){ return []; } }
  function saveLogs(a){ localStorage.setItem(LS_LOGS, JSON.stringify(a||[])); }

  function loadGame(){
    try{ return Object.assign({coins:0, hearts:5, xp:0, level:1, streak:0, lastLogin:null, nextFreeSpinAt:0}, JSON.parse(localStorage.getItem(LS_GAME)||'{}')); }
    catch(e){ return {coins:0, hearts:5, xp:0, level:1, streak:0, lastLogin:null, nextFreeSpinAt:0}; }
  }
  function saveGame(g){ localStorage.setItem(LS_GAME, JSON.stringify(g||{})); }
  function loadQuests(){
    try{ const q=JSON.parse(localStorage.getItem(LS_QUESTS)||'{}'); const today=localISO(); if(q.date!==today) return {date:today, completed:[]}; return q; }
    catch(e){ return {date:localISO(), completed:[]}; }
  }
  function saveQuests(q){ localStorage.setItem(LS_QUESTS, JSON.stringify(q||{})); }

  let game = loadGame();
  let dailyQuests = loadQuests();
  const QUEST_DEFS=[
    {id:'log', text:'Log an activity'},
    {id:'schedule', text:'Open Training Schedule'},
    {id:'spin', text:'Use daily spin'}
  ];

  function addCoins(n){ game.coins += n; saveGame(game); renderGameStatus(); }
  function addHearts(n){ game.hearts = Math.max(0, game.hearts + n); saveGame(game); renderGameStatus(); }
  function addXP(n){
    game.xp += n;
    while(game.xp >= game.level*100){ game.xp -= game.level*100; game.level++; }
    saveGame(game); renderGameStatus();
  }
  function renderGameStatus(){
    $('#coinsDisplay').textContent = game.coins;
    $('#heartsDisplay').textContent = game.hearts;
    $('#levelDisplay').textContent = `Lv ${game.level}`;
  }
  function renderQuests(){
    const list=$('#questsList'); if(!list) return;
    list.innerHTML='';
    QUEST_DEFS.forEach(q=>{
      const done=dailyQuests.completed.includes(q.id);
      const li=document.createElement('li');
      li.innerHTML=`<div class="flex items-center justify-between"><span>${q.text}</span><span class="${done?'text-green-600':'text-gray-400'}">${done?'✓':'—'}</span></div>`;
      list.appendChild(li);
    });
  }
  function recordQuest(id){
    if(!dailyQuests.completed.includes(id)){
      dailyQuests.completed.push(id);
      saveQuests(dailyQuests);
      addCoins(5); addXP(5);
      renderQuests();
    }
  }

  function handleDailyLogin(){
    const today=localISO();
    if(game.lastLogin!==today){
      if(game.lastLogin && daysBetweenLocal(game.lastLogin, today)===1){ game.streak++; } else { game.streak=1; }
      game.lastLogin=today;
      saveGame(game);
      dailyQuests={date:today, completed:[]}; saveQuests(dailyQuests);
      addCoins(10); addXP(10);
    }
  }
  function canSpin(){ return Date.now() >= (game.nextFreeSpinAt||0); }
  function updateSpinInfo(){
    const el=$('#spinInfo'); if(!el) return;
    if(canSpin()){ el.textContent='Ready'; $('#spinBtn').disabled=false; }
    else { const ms=game.nextFreeSpinAt-Date.now(); const h=Math.ceil(ms/3600000); el.textContent=`Come back in ${h}h`; $('#spinBtn').disabled=true; }
  }
  function spinWheel(){
    if(!canSpin()) return;
    const rewards=[
      {type:'coins',amount:5,text:'+5 Coins'},
      {type:'coins',amount:10,text:'+10 Coins'},
      {type:'coins',amount:20,text:'+20 Coins'},
      {type:'hearts',amount:1,text:'+1 Heart'}
    ];
    const r=rewards[Math.floor(Math.random()*rewards.length)];
    if(r.type==='coins') addCoins(r.amount);
    if(r.type==='hearts') addHearts(r.amount);
    alert(`You won ${r.text}`);
    game.nextFreeSpinAt=Date.now()+24*3600*1000; saveGame(game); updateSpinInfo();
    recordQuest('spin');
  }

  /* ===== Badge ===== */
  function updateGoalBadge(goalType){ const map = {lose:'Lose', maintain:'Maintain', gain:'Gain'}; const el = $('#goalBadge'); el.textContent = map[goalType] || 'Goal'; el.classList.remove('hidden'); }

  /* ===== MET/конвертации ===== */
  function kcalPerMinute(met, w){ return met*w*3.5/200; }
  function kcalPerStep(w, hcm){ const hm=hcm/100, stepLen=hm*0.415, stepsPerMin=(5000/60)/stepLen; return kcalPerMinute(3.5, w)/stepsPerMin; }
  function amountFromKcal(type, kcal, w, hcm){
    if(kcal<=0) return 0;
    if(type==='run')   return Math.ceil(kcal / kcalPerMinute(9.8, w));
    if(type==='cycle') return Math.ceil(kcal / kcalPerMinute(7.5, w));
    return Math.ceil(kcal / kcalPerStep(w, hcm));
  }

  /* ===== Итоги цели ===== */
  function getGoalTotals(){
    const p=readProfile();
    if(!hasProfile()) return {remainingKcal:0, daysLeft:0, dailyTarget:0};

    const start = p.startDate || localISO();
    const totalDays = (p.goal==='maintain') ? 0 : Math.max(7, (+p.days || 30));
    const todayISO = localISO();

    const daysPassed = (p.goal==='maintain') ? 0 : Math.max(0, daysBetweenLocal(start, todayISO));
    const daysLeft   = (p.goal==='maintain') ? 0 : Math.max(1, totalDays - daysPassed);

    const totalNeeded = Math.max(0, Math.abs((+p.targetWeight||+p.weight) - +p.weight) * kcalPerKg);
    const burned = getLogs().reduce((s,l)=>s+l.kcal,0);
    const remainingKcal = Math.max(0, totalNeeded - burned);

    const dailyTarget = (p.goal==='maintain' || remainingKcal===0) ? 0 : Math.ceil(remainingKcal / daysLeft);
    return {remainingKcal, daysLeft, dailyTarget};
  }

  /* ===== Автоплан недели ===== */
  function autoFillScheduleFromDailyTarget(overwriteZeroOnly=true){
    if(!hasProfile()) return;
    const p=readProfile();
    const { dailyTarget } = getGoalTotals();
    if(!dailyTarget || !isFinite(dailyTarget) || dailyTarget<=0) return;

    const w=+p.weight||70, h=+p.height||170;
    const sched=getSchedule();

    WEEK.forEach(day=>{
      const key=day.toLowerCase();
      const cur=sched[key] || {type:'walk', amount:0};
      if(overwriteZeroOnly && cur.amount>0){ sched[key]=cur; return; }
      const type = cur.type || 'walk';
      sched[key] = { type, amount: amountFromKcal(type, dailyTarget, w, h) };
    });

    saveSchedule(sched);
  }

  /* ===== Пересчёт и вывод ===== */
  function recalcFromProfile(){
    const p=readProfile(); if(!hasProfile()) return;
    const g=p.gender||'male', w=+p.weight, h=+p.height, act=+p.activity, age=+p.age, hm=h/100;

    const bmr=(10*w)+(6.25*h)-(5*age)+(g==='male'?5:-161);
    const tdee=bmr*act;

    const goal=p.goal;
    const wTarget = (goal==='maintain') ? w : ((typeof p.targetWeight==='number' && p.targetWeight>0) ? +p.targetWeight : w);
    const days=(goal!=='maintain') ? Math.max(7,(+p.days||30)) : 0;

    const dKg=Math.abs(wTarget-w), totalΔ=dKg*kcalPerKg, dailyΔ=(goal==='maintain')?0: totalΔ/Math.max(7,days);

    let tgt=tdee, txt='Maintain';
    if(goal==='lose'){tgt=tdee-dailyΔ;txt=`Lose (-${Math.round(dailyΔ)})`}
    if(goal==='gain'){tgt=tdee+dailyΔ;txt=`Gain (+${Math.round(dailyΔ)})`}

    const bmiNow=w/(hm*hm), bmiGoal=wTarget/(hm*hm);

    // Вывод
    $('#bmr').textContent=Math.round(bmr);
    $('#tdee').textContent=Math.round(tdee);
    $('#goalCalories').textContent=Math.round(tgt);
    $('#goalText').textContent=txt;
    $('#bmiNow').textContent=bmiNow.toFixed(1);
    $('#bmiGoal').textContent='Goal BMI: '+bmiGoal.toFixed(1);

    // Витрина эквивалентов
    const kcalMin=m=>kcalPerMinute(m,w);
    const stepsPerMin=(5000/60)/(hm*0.415);
    const kcalPerStepLocal=kcalMin(3.5)/stepsPerMin;
    const d=Math.abs(dailyΔ);
    const dSteps=Math.ceil(d/kcalPerStepLocal)||0;
    const dRun  =Math.ceil(d/kcalMin(9.8))||0;
    const dCyc  =Math.ceil(d/kcalMin(7.5))||0;
    const tSteps=dKg?Math.ceil(totalΔ/kcalPerStepLocal).toLocaleString()+' steps':'–';
    const tRun  =dKg?Math.ceil(totalΔ/kcalMin(9.8))+' min':'–';
    const tCyc  =dKg?Math.ceil(totalΔ/kcalMin(7.5))+' min':'–';

    $('#steps').textContent=dSteps.toLocaleString();
    $('#stepsCalories').textContent=Math.round(d);
    $('#running').textContent=dRun+' min';
    $('#runningCalories').textContent=Math.round(d);
    $('#cycling').textContent=dCyc+' min';
    $('#cyclingCalories').textContent=Math.round(d);
    $('#stepsTotal').textContent=tSteps;
    $('#runningTotal').textContent=tRun;
    $('#cyclingTotal').textContent=tCyc;

    updateGoalBadge(goal);
    updateProgressBar();
    renderDailyTargetPanel();

    autoFillScheduleFromDailyTarget(true);
    renderSchedule();
    renderTodayPlan();
  }

  function updateProgressBar(){
    const p=readProfile(), bar=$('#goalProgressBar'), txt=$('#goalProgressText');
    if(!hasProfile()){ bar.style.width='0%'; txt.textContent='0% completed'; return; }
    if(p.goal==='maintain'){ bar.style.width='0%'; txt.textContent='Maintain mode'; return; }
    const totalNeeded=Math.max(0, Math.abs((+p.targetWeight||+p.weight) - +p.weight) * kcalPerKg);
    if(!totalNeeded){ bar.style.width='0%'; txt.textContent='0% completed'; return; }
    const burned=getLogs().reduce((s,l)=>s+l.kcal,0);
    const pct=Math.max(0,Math.min(100, Math.round(100*burned/totalNeeded)));
    bar.style.width=pct+'%';
    txt.textContent=`${pct}% completed (${burned.toLocaleString()} / ${Math.round(totalNeeded).toLocaleString()} kcal)`;
  }

  function renderDailyTargetPanel(){
    const {remainingKcal, daysLeft, dailyTarget} = getGoalTotals();
    $('#remainingKcal').textContent = remainingKcal.toLocaleString();
    $('#daysLeft').textContent = daysLeft;
    $('#dailyTargetKcal').textContent = dailyTarget;
  }

  function renderSchedule(){
    const grid=$('#scheduleGrid'); if(!grid) return;
    grid.innerHTML='';
    const p=readProfile(); const w=+p.weight||70, h=+p.height||170;
    const { dailyTarget } = getGoalTotals();
    $('#scheduleHint').textContent = dailyTarget>0 ? `The week is auto-filled from your daily target: ${dailyTarget} kcal.` : 'Maintain: no deficit/surplus. Fill targets if you want to keep habits.';

    const sched=getSchedule();

    WEEK.forEach(day=>{
      const key=day.toLowerCase();
      const item=sched[key] || {type:'walk', amount:0};

      const suggWalk = amountFromKcal('walk',  dailyTarget, w, h);
      const suggRun  = amountFromKcal('run',   dailyTarget, w, h);
      const suggCyc  = amountFromKcal('cycle', dailyTarget, w, h);

      const card=document.createElement('div');
      card.className='border rounded-lg p-4 bg-white';
      card.innerHTML=`
        <div class="flex items-center justify-between mb-2">
          <div class="font-medium">${day}</div>
          <div class="hint">${dailyTarget>0?`Daily target: ${dailyTarget} kcal`:`Maintain`}</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Type</label>
            <select data-day="${key}" data-field="type" class="w-full border rounded-lg px-3 py-2">
              <option value="walk"${item.type==='walk'?' selected':''}>Walking</option>
              <option value="run"${item.type==='run'?' selected':''}>Running</option>
              <option value="cycle"${item.type==='cycle'?' selected':''}>Cycling</option>
            </select>
            <div class="hint mt-1">
              Suggest: Walk ${suggWalk.toLocaleString()} steps · Run ${suggRun} min · Cycle ${suggCyc} min
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Target</label>
            <input type="number" min="0" value="${item.amount||0}" data-day="${key}" data-field="amount"
                   class="w-full border rounded-lg px-3 py-2" placeholder="steps/min">
            <div class="hint mt-1">You can tweak and Save</div>
          </div>
        </div>`;
      grid.appendChild(card);
    });
  }

  function renderTodayPlan(){
    const sched=getSchedule();
    const { dailyTarget } = getGoalTotals();
    const today=new Date();
    const idx=(today.getDay()+6)%7; // Mon=0
    const key=WEEK[idx].toLowerCase();
    const item=sched[key];
    const el=$('#todayPlan');
    if(!item){ el.textContent=`No target set for today${dailyTarget>0?`. Daily kcal target: ${dailyTarget}`:''}`; return; }
    const label=item.type==='walk'?'steps':'min';
    el.textContent=`${WEEK[idx]}: ${item.type} — target ${item.amount||0} ${label}${dailyTarget>0?` (~${dailyTarget} kcal)`:''}`;
  }

  /* ===== Maintain locks ===== */
  function applyMaintainLocks(scope){
    const goalEl   = document.getElementById(scope==='ob' ? 'obGoal'   : 'pfGoal');
    const unitsEl  = document.getElementById(scope==='ob' ? 'obUnits'  : 'pfUnits');
    const isMaintain = goalEl && goalEl.value === 'maintain';

    const targetMetricWrap = document.getElementById(scope==='ob' ? 'obTargetMetricWrap' : 'pfTargetMetricWrap');
    const targetImperialWrap = document.getElementById(scope==='ob' ? 'obTargetImperialWrap' : 'pfTargetImperialWrap');
    const daysWrap = document.getElementById(scope==='ob' ? 'obDaysWrap' : 'pfDaysWrap');

    const u = unitsEl ? unitsEl.value : 'metric';
    const targetInput = (u==='imperial')
      ? document.getElementById(scope==='ob' ? 'obTargetLb' : 'pfTargetLb')
      : document.getElementById(scope==='ob' ? 'obTargetKg' : 'pfTargetKg');

    const weightInput = (u==='imperial')
      ? document.getElementById(scope==='ob' ? 'obWeightLb' : 'pfWeightLb')
      : document.getElementById(scope==='ob' ? 'obWeightKg' : 'pfWeightKg');

    if(isMaintain){
      if(weightInput && targetInput){ targetInput.value = weightInput.value || ''; }
      targetMetricWrap && targetMetricWrap.classList.add('opacity-50','pointer-events-none');
      targetImperialWrap && targetImperialWrap.classList.add('opacity-50','pointer-events-none');
      daysWrap && daysWrap.classList.add('opacity-50','pointer-events-none');
      if(targetInput) targetInput.disabled = true;
      const daysEl = document.getElementById(scope==='ob' ? 'obDays' : 'pfDays');
      if(daysEl){ daysEl.value = ''; daysEl.disabled = true; }
    } else {
      targetMetricWrap && targetMetricWrap.classList.remove('opacity-50','pointer-events-none');
      targetImperialWrap && targetImperialWrap.classList.remove('opacity-50','pointer-events-none');
      daysWrap && daysWrap.classList.remove('opacity-50','pointer-events-none');
      if(targetInput) targetInput.disabled = false;
      const daysEl = document.getElementById(scope==='ob' ? 'obDays' : 'pfDays');
      if(daysEl){ daysEl.disabled = false; }
    }
  }
  function keepTargetEqualToWeight(scope){
    const goalEl = document.getElementById(scope==='ob' ? 'obGoal' : 'pfGoal');
    const unitsEl= document.getElementById(scope==='ob' ? 'obUnits': 'pfUnits');
    if(!goalEl || goalEl.value!=='maintain') return;
    const u = unitsEl ? unitsEl.value : 'metric';
    const weightInput = (u==='imperial')
      ? document.getElementById(scope==='ob' ? 'obWeightLb' : 'pfWeightLb')
      : document.getElementById(scope==='ob' ? 'obWeightKg' : 'pfWeightKg');
    const targetInput = (u==='imperial')
      ? document.getElementById(scope==='ob' ? 'obTargetLb' : 'pfTargetLb')
      : document.getElementById(scope==='ob' ? 'obTargetKg' : 'pfTargetKg');
    if(weightInput && targetInput){ targetInput.value = weightInput.value || ''; }
  }

  /* ===== Units UI switches ===== */
  function switchUnitsUI(scope, units){
    const isImp = units==='imperial';

    const wMW = document.getElementById(scope==='ob'?'obWeightMetricWrap':'pfWeightMetricWrap');
    const wIW = document.getElementById(scope==='ob'?'obWeightImperialWrap':'pfWeightImperialWrap');
    const hMW = document.getElementById(scope==='ob'?'obHeightMetricWrap':'pfHeightMetricWrap');
    const hIW = document.getElementById(scope==='ob'?'obHeightImperialWrap':'pfHeightImperialWrap');
    const tMW = document.getElementById(scope==='ob'?'obTargetMetricWrap':'pfTargetMetricWrap');
    const tIW = document.getElementById(scope==='ob'?'obTargetImperialWrap':'pfTargetImperialWrap');

    wMW.classList.toggle('hidden', isImp); wIW.classList.toggle('hidden', !isImp);
    hMW.classList.toggle('hidden', isImp); hIW.classList.toggle('hidden', !isImp);
    tMW.classList.toggle('hidden', isImp); tIW.classList.toggle('hidden', !isImp);

    // конвертация текущих значений отображения (без изменения сохранённого профиля)
    if(scope==='pf'){
      const p=readProfile();
      const kg = +p.weight||0, cm = +p.height||0, tKg = +p.targetWeight || kg;
      if(isImp){
        $('#pfWeightLb').value = kg ? (kgToLb(kg).toFixed(1)) : '';
        const h = cmToFtIn(cm); $('#pfHeightFt').value = h.ft||''; $('#pfHeightIn').value = (h.inch||'');
        $('#pfTargetLb').value = tKg ? (kgToLb(tKg).toFixed(1)) : '';
      } else {
        $('#pfWeightKg').value = kg || '';
        $('#pfHeightCm').value = cm || '';
        $('#pfTargetKg').value = tKg || '';
      }
    } else {
      // onboarding: заполняем из текущих полей, если они есть
      const kg = +$('#obWeightKg').value || 0;
      const cm = +$('#obHeightCm').value || 0;
      const tKg= +$('#obTargetKg').value || kg;
      if(isImp){
        if(kg){ $('#obWeightLb').value = kgToLb(kg).toFixed(1); }
        if(cm){ const h = cmToFtIn(cm); $('#obHeightFt').value = h.ft||''; $('#obHeightIn').value = h.inch||''; }
        if(tKg){ $('#obTargetLb').value = kgToLb(tKg).toFixed(1); }
      } else {
        const lb = +$('#obWeightLb').value || 0;
        const ft = +$('#obHeightFt').value || 0;
        const inch = +$('#obHeightIn').value || 0;
        const tLb = +$('#obTargetLb').value || lb;
        if(lb){ $('#obWeightKg').value = lbToKg(lb).toFixed(1); }
        if(ft || inch){ $('#obHeightCm').value = ftInToCm(ft, inch).toFixed(1); }
        if(tLb){ $('#obTargetKg').value = lbToKg(tLb).toFixed(1); }
      }
    }
    applyMaintainLocks(scope); // чтобы правильно дизэйблить цели/срок
  }

  /* ===== Сохранение расписания ===== */
  document.getElementById('btnSaveSchedule').addEventListener('click', ()=>{
    const sched={};
    document.querySelectorAll('#scheduleGrid [data-day]').forEach(el=>{
      const day=el.getAttribute('data-day'), field=el.getAttribute('data-field');
      sched[day]=sched[day]||{type:'walk', amount:0};
      if(field==='type')   sched[day].type=el.value;
      if(field==='amount') sched[day].amount=+el.value||0;
    });
    saveSchedule(sched);
    alert('Schedule saved');
    renderTodayPlan();
  });

  /* ===== Log ===== */
  function todayISO(){ return localISO(); }
  document.getElementById('logDate').value = todayISO();
  function computeKcalForEntry(type, amount){
    const p=readProfile(); const w=+p.weight||70, h=+p.height||170;
    if(type==='run')   return Math.round((+amount||0) * kcalPerMinute(9.8, w));
    if(type==='cycle') return Math.round((+amount||0) * kcalPerMinute(7.5, w));
    return Math.round((+amount||0) * kcalPerStep(w, h));
  }
  function renderLog(){
    const tb=$('#logTable'); tb.innerHTML='';
    const rows=getLogs().sort((a,b)=>a.date<b.date?-1:1);
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="px-3 py-2 border-b">${r.date}</td>
        <td class="px-3 py-2 border-b">${r.type}</td>
        <td class="px-3 py-2 border-b">${r.amount}</td>
        <td class="px-3 py-2 border-b">${r.kcal}</td>
        <td class="px-3 py-2 border-b"><button data-id="${r.id}" class="text-rose-600 hover:underline">Delete</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-id]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id=+b.getAttribute('data-id');
        const logs=getLogs().filter(x=>x.id!==id);
        saveLogs(logs); renderLog(); updateProgressBar(); renderDailyTargetPanel();
      });
    });

    const logs=getLogs();
    const today=todayISO();
    const kcalToday=logs.filter(l=>l.date===today).reduce((s,l)=>s+l.kcal,0);
    const now=new Date();
    const monday=new Date(now); const day=(now.getDay()+6)%7; monday.setDate(now.getDate()-day);
    const sunday=new Date(monday); sunday.setDate(monday.getDate()+6);
    const weekSum=logs.filter(l=>{const ld=parseISO(l.date); return ld>=monday&&ld<=sunday;})
                      .reduce((s,l)=>s+l.kcal,0);
    const total=logs.reduce((s,l)=>s+l.kcal,0);
    $('#kcalToday').textContent=kcalToday;
    $('#kcalWeek').textContent=weekSum;
    $('#kcalTotal').textContent=total;
  }
  document.getElementById('btnAddLog').addEventListener('click', ()=>{
    if(!hasProfile()){ alert('Please complete onboarding first.'); return; }
    const d=$('#logDate').value||todayISO();
    const t=$('#logType').value;
    const a=+$('#logAmount').value||0;
    if(a<=0){ alert('Enter amount'); return; }
    const kcal=computeKcalForEntry(t,a);
    const logs=getLogs(); logs.push({id:Date.now(), date:d, type:t, amount:a, kcal});
    saveLogs(logs); $('#logAmount').value='';
    renderLog(); updateProgressBar(); renderDailyTargetPanel();
    addCoins(1); addXP(1); recordQuest('log');
  });
  document.getElementById('btnClearLog').addEventListener('click', ()=>{
    if(confirm('Clear all log entries?')){ saveLogs([]); renderLog(); updateProgressBar(); renderDailyTargetPanel(); }
  });

  /* ===== Профиль (модалка) ===== */
  const profileModal=$('#profileModal');
  $('#openProfile').addEventListener('click', ()=>{
    const p=readProfile();
    $('#pfUnits').value=p.units||'metric';
    $('#pfGoal').value=p.goal||'maintain';
    $('#pfGender').value=p.gender||'male';
    $('#pfAge').value=p.age??'';
    $('#pfActivity').value=p.activity??'1.2';

    // Подставляем значения по текущим единицам
    switchUnitsUI('pf', $('#pfUnits').value);
    if(($('#pfUnits').value||'metric')==='imperial'){
      $('#pfWeightLb').value = p.weight? kgToLb(+p.weight).toFixed(1):'';
      const h = p.height? cmToFtIn(+p.height):{ft:'',inch:''};
      $('#pfHeightFt').value = h.ft||'';
      $('#pfHeightIn').value = h.inch||'';
      $('#pfTargetLb').value = (p.goal==='maintain') ? (p.weight?kgToLb(+p.weight).toFixed(1):'') : (p.targetWeight?kgToLb(+p.targetWeight).toFixed(1):'');
    } else {
      $('#pfWeightKg').value = p.weight??'';
      $('#pfHeightCm').value = p.height??'';
      $('#pfTargetKg').value = (p.goal==='maintain') ? (p.weight??'') : (p.targetWeight??'');
    }
    $('#pfDays').value=(p.goal==='maintain') ? '' : (p.days??'');

    profileModal.classList.remove('hidden');
    applyMaintainLocks('pf');
    lockBodyScroll();
  });
  $('#closeProfile').addEventListener('click', ()=>{ profileModal.classList.add('hidden'); unlockBodyScroll(); });

  // Переключение единиц в профиле
  $('#pfUnits').addEventListener('change', ()=>{
    switchUnitsUI('pf', $('#pfUnits').value);
    keepTargetEqualToWeight('pf');
  });
  $('#pfGoal').addEventListener('change', ()=>applyMaintainLocks('pf'));
  // weight sync для Maintain
  $('#pfWeightKg')?.addEventListener('input', ()=>keepTargetEqualToWeight('pf'));
  $('#pfWeightLb')?.addEventListener('input', ()=>keepTargetEqualToWeight('pf'));

  $('#saveProfileModal').addEventListener('click', ()=>{
    const prev=readProfile();
    const goal = $('#pfGoal').value;
    const units = $('#pfUnits').value || 'metric';

    // читаем вес/рост в выбранных единицах, конвертируем в kg/cm
    let weightKg, heightCm, targetKg;
    if(units==='imperial'){
      const lb = +($('#pfWeightLb').value||0);
      const ft = +($('#pfHeightFt').value||0);
      const inch = +($('#pfHeightIn').value||0);
      weightKg = lb? lbToKg(lb): null;
      heightCm = (ft||inch)? ftInToCm(ft, inch): null;
      const tLb = +($('#pfTargetLb').value||0);
      targetKg = (goal==='maintain') ? weightKg : (tLb? lbToKg(tLb): weightKg);
    } else {
      weightKg = +($('#pfWeightKg').value||0) || null;
      heightCm = +($('#pfHeightCm').value||0) || null;
      const t = +($('#pfTargetKg').value||0);
      targetKg = (goal==='maintain') ? weightKg : (t? t : weightKg);
    }

    const p={
      goal,
      units,
      gender: $('#pfGender').value,
      age: +$('#pfAge').value||null,
      weight: weightKg,
      height: heightCm,
      activity: +($('#pfActivity').value)||1.2,
      targetWeight: targetKg,
      days: (goal==='maintain') ? null : Math.max(7,(+$('#pfDays').value || 30)),
      startDate: prev.startDate || localISO()
    };
    if(!p.age || !p.weight || !p.height){ alert('Please fill age, weight and height'); return; }
    writeProfile(p);
    profileModal.classList.add('hidden');
    unlockBodyScroll();

    recalcFromProfile();
    autoFillScheduleFromDailyTarget(true);
    renderSchedule();
    renderTodayPlan();
  });

  // ЖЁСТКИЙ RESET
  $('#resetProfile').addEventListener('click', ()=>{
    if(!confirm('Reset profile?')) return;
    localStorage.removeItem(LS_PROFILE);
    localStorage.removeItem(LS_SCHEDULE);
    localStorage.removeItem(LS_LOGS);
    location.replace(location.href);
  });

  /* ===== Онбординг ===== */
  const ob=$('#onboarding');
  function showOnboarding(){ ob.classList.remove('hidden'); switchUnitsUI('ob', $('#obUnits').value||'metric'); applyMaintainLocks('ob'); lockBodyScroll(); }
  function hideOnboarding(){ ob.classList.add('hidden'); unlockBodyScroll(); }

  // переключение единиц в онбординге
  $('#obUnits').addEventListener('change', ()=>{
    switchUnitsUI('ob', $('#obUnits').value);
    keepTargetEqualToWeight('ob');
  });
  $('#obGoal').addEventListener('change', ()=>applyMaintainLocks('ob'));
  $('#obWeightKg')?.addEventListener('input', ()=>keepTargetEqualToWeight('ob'));
  $('#obWeightLb')?.addEventListener('input', ()=>keepTargetEqualToWeight('ob'));

  $('#obSave').addEventListener('click', ()=>{
    const goal = $('#obGoal').value;
    const units = $('#obUnits').value || 'metric';

    let weightKg, heightCm, targetKg;
    if(units==='imperial'){
      const lb = +($('#obWeightLb').value||0);
      const ft = +($('#obHeightFt').value||0);
      const inch = +($('#obHeightIn').value||0);
      weightKg = lb? lbToKg(lb): null;
      heightCm = (ft||inch)? ftInToCm(ft, inch): null;
      const tLb = +($('#obTargetLb').value||0);
      targetKg = (goal==='maintain') ? weightKg : (tLb? lbToKg(tLb): weightKg);
    } else {
      weightKg = +($('#obWeightKg').value||0) || null;
      heightCm = +($('#obHeightCm').value||0) || null;
      const t = +($('#obTargetKg').value||0);
      targetKg = (goal==='maintain') ? weightKg : (t? t : weightKg);
    }

    const profile = {
      goal,
      units,
      gender: $('#obGender').value,
      age: +($('#obAge').value) || null,
      weight: weightKg,
      height: heightCm,
      activity: +($('#obActivity').value) || 1.55, // теперь поле есть
      targetWeight: targetKg,
      days: (goal==='maintain') ? null : Math.max(7,(+($('#obDays').value) || 30)),
      startDate: localISO()
    };
    if (!profile.age || !profile.weight || !profile.height) { alert('Please fill age, weight, and height'); return; }

    writeProfile(profile);
    hideOnboarding();

    recalcFromProfile();
    autoFillScheduleFromDailyTarget(true);
    renderSchedule();
    renderTodayPlan();
    switchTab('tabDashboard');
  });

  /* ===== Tabs ===== */
  function switchTab(id){
    document.querySelectorAll('.tab-button').forEach(btn=>{
      btn.classList.toggle('text-indigo-600',btn.id===id);
      btn.classList.toggle('border-indigo-600',btn.id===id);
      btn.classList.toggle('text-gray-500',btn.id!==id);
    });
    $('#dashboardTab').classList.toggle('hidden',id!=='tabDashboard');
    $('#activityTab').classList.toggle('hidden',id!=='tabActivity');
    $('#scheduleTab').classList.toggle('hidden',id!=='tabSchedule');
    $('#logTab').classList.toggle('hidden',id!=='tabLog');

    if(id==='tabDashboard'){
      document.querySelectorAll('#dashboardTab .result-card').forEach(c=>c.classList.remove('show'));
      setTimeout(()=>document.querySelectorAll('#dashboardTab .result-card')
        .forEach((c,i)=>setTimeout(()=>c.classList.add('show'),i*100)),50);
    }
    if(id==='tabActivity'){
      document.querySelectorAll('#activityTab .activity-card').forEach(c=>c.classList.remove('show'));
      setTimeout(()=>document.querySelectorAll('#activityTab .activity-card')
        .forEach((c,i)=>setTimeout(()=>c.classList.add('show'),i*100)),50);
    }
    if(id==='tabLog'){ renderLog(); }
    if(id==='tabSchedule'){ renderSchedule(); recordQuest('schedule'); }
  }
  document.querySelectorAll('.tab-button').forEach(b=>b.addEventListener('click',()=>switchTab(b.id)));

  /* ===== Init ===== */
  window.onload = ()=>{
    handleDailyLogin();
    renderGameStatus();
    renderQuests();
    updateSpinInfo();
    if(!hasProfile()){
      showOnboarding();
    } else {
      recalcFromProfile();
      autoFillScheduleFromDailyTarget(true);
      renderSchedule();
      renderTodayPlan();
      switchTab('tabDashboard');
    }
  };
</script>
</body>
</html>
